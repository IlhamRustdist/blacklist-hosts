name: Update Hosts Registry

on:
  push:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: update-hosts
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch Sources
        shell: bash
        run: |
          set -Eeuo pipefail

          declare -A SOURCES=(

            ["ads-track/adguard"]="https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt"
            ["ads-track/oisd-big"]="https://big.oisd.nl"
            ["ads-track/oisd-small"]="https://small.oisd.nl"

            ["ads-track/1hosts-lite"]="https://raw.githubusercontent.com/badmojr/1Hosts/master/Lite/adblock.txt"
            ["ads-track/1hosts-xtra"]="https://raw.githubusercontent.com/badmojr/1Hosts/master/Xtra/adblock.txt"

            ["unified/stevenblack"]="https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"

            ["hagezi/ultimate"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/ultimate.txt"
            ["hagezi/doh"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/doh-vpn-proxy-bypass.txt"
            ["hagezi/dga"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/dga30.txt"
            ["hagezi/tif"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.txt"

            ["security/urlhaus"]="https://urlhaus.abuse.ch/downloads/hostfile/"
            ["security/phishing-army"]="https://phishing.army/download/phishing_army_blocklist_extended.txt"
            ["security/nocoin"]="https://raw.githubusercontent.com/hoshsadiq/adblock-nocoin-list/master/hosts.txt"
          )

          rm -rf hosts
          mkdir -p hosts

          download() {
            local url="$1"
            local out="$2"

            if curl -L --retry 3 --connect-timeout 20 --max-time 120 \
              -A "Mozilla/5.0" --fail "$url" -o "$out"; then
              echo "✓ OK"
            else
              echo "⚠ Failed: $url"
              rm -f "$out"
            fi
          }

          normalize() {
            file="$1"

            sed -i -E '
              s#^\|\|([^/\^\$]+).*#0.0.0.0 \1#;
              s#^([^#].*\..*)$#0.0.0.0 \1#;
            ' "$file"

            sed -i -E '
              s#^(0\.0\.0\.0|127\.0\.0\.1)[[:space:]]+([^[:space:]]+).*#0.0.0.0 \2#
            ' "$file"

            grep -E '^0\.0\.0\.0 ' "$file" | sort -u > "$file.tmp"
            mv "$file.tmp" "$file"
          }

          for path in "${!SOURCES[@]}"; do
            url="${SOURCES[$path]}"
            dest="hosts/$path.txt"

            mkdir -p "$(dirname "$dest")"
            echo "Downloading $path"

            download "$url" "$dest" || true

            if [ -f "$dest" ]; then
              normalize "$dest"
              [ ! -s "$dest" ] && rm -f "$dest"
            fi
          done

          # MASTER MERGE
          mkdir -p hosts/merged
          find hosts -type f ! -path "*/merged/*" -exec cat {} + \
            | grep -E '^0\.0\.0\.0 ' \
            | sort -u > hosts/merged/master.txt

      - name: Generate README
        shell: bash
        run: |
          set -Eeuo pipefail

          BASE="https://raw.githubusercontent.com/${{ github.repository }}/main"
          total=0

          count_domains() {
            awk '{print $2}' "$1" | sort -u | wc -l
          }

          cat > README.md <<EOF
          # Blacklist Hosts

          Curated multi-source domain block registry.

          ## Statistics

          | File | Domains |
          |------|--------|
          EOF

          while read -r file; do
            count=$(count_domains "$file" || echo 0)
            total=$((total + count))
            echo "| [\`$file\`]($BASE/$file) | $count |" >> README.md
          done < <(find hosts -type f | sort)

          echo "" >> README.md
          echo "**Total Domains (All Files Combined):** $total" >> README.md
          echo "" >> README.md
          echo "Last Updated: $(TZ=Asia/Jakarta date '+%Y-%m-%d %H:%M WIB')" >> README.md

      - name: Commit Changes
        run: |
          set -Eeuo pipefail

          git config user.name github-actions
          git config user.email github-actions@github.com

          git add .

          git diff --cached --quiet && exit 0

          git commit -m "auto: update hosts"

          git pull --rebase origin main || true
          git push origin HEAD:main
