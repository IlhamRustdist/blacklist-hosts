name: Update Hosts Registry

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: update-hosts
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch Sources
        shell: bash
        run: |
          set -Eeuo pipefail

          declare -A SOURCES=(

            ["ads-track/adguard.txt"]="https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt"
            ["ads-track/d3host.txt"]="https://raw.githubusercontent.com/Turtlecute33/toolz/master/src/d3host.adblock"

            ["fakenews/stevenblack.txt"]="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews/hosts"
            ["gambling/stevenblack.txt"]="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/gambling/hosts"
            ["porn/stevenblack.txt"]="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/porn/hosts"
            ["unified/stevenblack.txt"]="https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"

            ["porn/oisd"]="https://nsfw.oisd.nl"
            ["ads-track/oisd"]="https://big.oisd.nl"

            ["hagezi/ultimate"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/ultimate.txt"
            ["hagezi/tif"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/tif.txt"
            ["hagezi/dyndns"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/dyndns.txt"
            ["hagezi/hoster"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/hoster.txt"
            ["hagezi/spam-tlds"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/spam-tlds.txt"
            ["hagezi/dga"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/dga30.txt"
            ["hagezi/gambling"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/gambling.txt"
            ["hagezi/anti-piracy"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/anti.piracy.txt"
            ["hagezi/nosafesearch"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/nosafesearch.txt"
            ["hagezi/doh"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/doh-vpn-proxy-bypass.txt"
            ["hagezi/nsfw"]="https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/nsfw.txt"
               # =========================
            # GENERAL - Full Coverage
            # =========================

            ["ads-track/1hosts-lite"]="https://raw.githubusercontent.com/badmojr/1Hosts/master/Lite/adblock.txt"
            ["ads-track/1hosts-xtra"]="https://raw.githubusercontent.com/badmojr/1Hosts/master/Xtra/adblock.txt"

            ["ads-track/adguard-dns"]="https://adguardteam.github.io/HostlistsRegistry/assets/filter_2.txt"
            ["ads-track/adguard-popup"]="https://adguardteam.github.io/HostlistsRegistry/assets/filter_19.txt"

            ["ads-track/awavenue"]="https://raw.githubusercontent.com/awaavenue/adblockrules/master/hosts.txt"
            ["ads-track/danpollock"]="https://someonewhocares.org/hosts/zero/hosts"
            ["ads-track/peterlowe"]="https://pgl.yoyo.org/adservers/serverlist.php?hostformat=hosts&showintro=0&mimetype=plaintext"

            ["ads-track/shadowwhisperer-tracking"]="https://raw.githubusercontent.com/ShadowWhisperer/BlockLists/master/Tracking"

            ["ads-track/oisd-small"]="https://small.oisd.nl"

            # =========================
            # OTHER
            # =========================

            ["other/anti-push"]="https://raw.githubusercontent.com/DandelionSprout/adfilt/master/AntiPushNotifications.txt"
            ["other/game-console"]="https://raw.githubusercontent.com/DandelionSprout/adfilt/master/GameConsoleAdblock.txt"
            ["other/smart-tv"]="https://raw.githubusercontent.com/DandelionSprout/adfilt/master/SmartTV.txt"

            ["other/no-google"]="https://raw.githubusercontent.com/nickspaargaren/no-google/master/pihole-google.txt"

            # =========================
            # REGIONAL - COMPLETE
            # =========================

            ["regional/chn-adrules"]="https://raw.githubusercontent.com/Cats-Team/AdRules/master/dns.txt"
            ["regional/chn-antiad"]="https://anti-ad.net/easylist.txt"

            ["regional/hun-hufilter"]="https://raw.githubusercontent.com/hufilter/hufilter/master/hufilter-hosts.txt"

            ["regional/idn-abpindo"]="https://raw.githubusercontent.com/ABPindo/indonesianadblockrules/master/subscriptions/abpindo.txt"

            ["regional/irn-persianblocker"]="https://raw.githubusercontent.com/MasterKia/PersianBlocker/main/PersianBlockerHosts.txt"

            ["regional/isr-easylist"]="https://raw.githubusercontent.com/easylist/EasyListHebrew/master/EasyListHebrew.txt"

            ["regional/kor-listkr"]="https://raw.githubusercontent.com/List-KR/List-KR/master/filter.txt"
            ["regional/kor-youslist"]="https://raw.githubusercontent.com/yous/YousList/master/youslist.txt"

            ["regional/lit-easylist"]="https://raw.githubusercontent.com/easylist/EasyListLithuania/master/easylistlithuania.txt"

            ["regional/mkd-pihole"]="https://raw.githubusercontent.com/iosifache/MacedonianPiHoleBlocklist/main/hosts"

            ["regional/nor-nordic"]="https://raw.githubusercontent.com/DandelionSprout/adfilt/master/NordicFilters.txt"

            ["regional/pol-cert"]="https://hole.cert.pl/domains/domains.txt"
            ["regional/pol-pihole"]="https://raw.githubusercontent.com/PolishFiltersTeam/KADhosts/master/KADhosts.txt"

            ["regional/swe-frellwits"]="https://raw.githubusercontent.com/frellwits/filter-lists/master/swedish-hosts.txt"

            ["regional/tur-adlist"]="https://raw.githubusercontent.com/AdguardTeam/TurkishFilter/master/hosts.txt"
            ["regional/tur-adhosts"]="https://raw.githubusercontent.com/BarisKayaoglu/TurkishAdHosts/master/hosts"

            ["regional/vnm-abpvn"]="https://raw.githubusercontent.com/abpvn/abpvn/master/filter/abpvn.txt"

            # =========================
            # SECURITY - COMPLETE
            # =========================

            ["security/phishing-urlhaus"]="https://urlhaus.abuse.ch/downloads/hostfile/"
            ["security/phishing-army"]="https://phishing.army/download/phishing_army_blocklist_extended.txt"

            ["security/nocoin"]="https://raw.githubusercontent.com/hoshsadiq/adblock-nocoin-list/master/hosts.txt"

            ["security/malware-shadowwhisperer"]="https://raw.githubusercontent.com/ShadowWhisperer/BlockLists/master/Malware"

            ["security/stalkerware"]="https://raw.githubusercontent.com/AssoEchap/stalkerware-indicators/master/generated/hosts"

            ["security/big-malware"]="https://raw.githubusercontent.com/mitchellkrogza/Badd-Boyz-Hosts/master/hosts"

            ["security/scam-durablenapkin"]="https://raw.githubusercontent.com/durablenapkin/scamblocklist/master/hosts.txt"
          )

          rm -rf hosts
          mkdir -p hosts

          for path in "${!SOURCES[@]}"; do
            url="${SOURCES[$path]}"
            dest="hosts/$path"

            mkdir -p "$(dirname "$dest")"

            echo "Downloading $path"

            # curl -L \
            #   -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
            #   -H "Accept: text/plain" \
            #   --retry 5 \
            #   --retry-delay 5 \
            #   --fail \
            #   "$url" -o "$dest"
            download() {
            local url="$1"
            local out="$2"

            if curl -L -A "Mozilla/5.0" --retry 3 --fail "$url" -o "$out"; then
            echo "✓ OK"
            else
            echo "⚠ Failed: $url"
            echo "" > "$out"
            fi
            }

            download "$url" "$dest"
          done

      - name: Generate README
        shell: bash
        run: |
          set -Eeuo pipefail

          BASE="https://raw.githubusercontent.com/${{ github.repository }}/main"
          total=0

          count_domains() {
          file="$1"

          grep -vE '^\s*($|!|#|@@)' "$file" 2>/dev/null \
          | sed -E '
          s#^\|\|([^/\^\$]+).*#\1#;
          s#^(0\.0\.0\.0|127\.0\.0\.1)[[:space:]]+([^[:space:]]+).*#\2#;
          ' \
          | grep -E '\.|/' \
          | sort -u \
          | wc -l
          }

          cat > README.md <<EOF
          # Blacklist Hosts

          Curated multi-source domain block registry.

          ## Statistics

          | File | Domains |
          |------|--------|
          EOF

          while read -r file; do
            count=$(count_domains "$file" || echo 0)
            total=$((total + count))
            echo "| [\`$file\`]($BASE/$file) | $count |" >> README.md
          done < <(find hosts -type f | sort)

          echo "" >> README.md
          echo "**Total Domains:** $total" >> README.md
          echo "" >> README.md
          echo "Last Updated: $(TZ=Asia/Jakarta date '+%Y-%m-%d %H:%M WIB')" >> README.md

      - name: Commit Changes
        run: |
          set -Eeuo pipefail

          git config user.name github-actions
          git config user.email github-actions@github.com

          git add .

          git diff --cached --quiet && exit 0

          git commit -m "auto: update hosts"

          git pull --rebase origin main || true
          git push origin HEAD:main
